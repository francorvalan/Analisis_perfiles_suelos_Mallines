---
title: |-
  Vegas Andinas
  análisis de datos Suelo
output:
  pdf_document: default
  html_document:
    df_print: paged
date: "2024-04-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=F}
dependencies<- c("aqp","Hmisc","lattice","MASS","dplyr","knitr","soiltexture","ggplot2","ggtern","kableExtra")
lapply(dependencies, require,character.only =T)

# Load data
horizons <- read.csv2("02_Data/Horizontes_CN.csv",fileEncoding ="UTF-8") %>% filter(complete.cases(Mallin)) %>%
  mutate(horizons_munsell_color = munsell2rgb(hue,value, chroma))

horizons$SAND <- as.numeric(horizons$Arena....)
horizons$SILT <- as.numeric(horizons$Limo....)
horizons$CLAY <- as.numeric(horizons$Arcilla....)


Normalizacion_texturas <- function(df,Arena,Limo,Arcilla){
  total <- horizons %>% select({{Arena}}, {{Limo}}, {{Arcilla}}) %>% rowSums(na.rm = T)

  df <- df %>%
  mutate(across(c({{Arena}}, {{Limo}}, {{Arcilla}}), ~ (. * 100) / total, .names = "{.col}"))
  
  return(df)
  }

horizons <- Normalizacion_texturas(horizons, "SAND", "SILT", "CLAY")

profiles <- horizons %>% select(Mallin) %>% unique()
#munsell::mnsl2hex()
horizons_B <- horizons
depths(horizons) <- Mallin  ~ top + bottom

```

# 1 Introducción

Se analizaron `r nrow(horizons) ` localizados en  `r length(horizons)`, comprendiendo distintas profundidades, abarcando desde la superfie hasta `r max(horizons$bottom)`. 

De los mismos, `r checkHzDepthLogic(horizons)%>% filter(valid==F) %>% nrow()` perfiles presentaron problemas en sus profundidades, los cuales se detallan a continuacion

```{r inlcude=F,echo=F, warning=F, message=F, eval=T,results='hide'}

horizons_checked <- checkHzDepthLogic(horizons)
site(horizons) <- horizons_checked
horizons$valid <- as.factor(horizons$valid)

kable( horizons_checked%>% filter(valid==F) %>% 
  as.data.frame() %>% 
  select(Mallin,sameDepth,missingDepth,overlapOrGap) %>% 
  mutate_all( ~ ifelse(. == FALSE, "-", .)) %>% 
  mutate_all( ~ ifelse(. == TRUE, "Si", .)) %>% 
  rename("Mallin"=Mallin,"Misma Profundidad"=sameDepth, 
         "Falta profundidad"=missingDepth,"Profundidades superpuestas"=overlapOrGap), align = "c")

```
```{r inlcude=F,echo=F, warning=F, message=F}
kable(horizons_B %>% filter(Mallin %in% (horizons_checked%>% filter(valid==F) %>% pull(Mallin))) %>% select(Mallin,top,bottom,SAND,SILT,CLAY), align = "c",caption = "Clasificacion textural de las capas analizadas",digits=1)

```




```{r include=F}
groupedProfilePlot(horizons, groups='valid', group.name.offset = -20)
title('Valid Horizonation Check')
```
```{r include=F}
library(stringr)
sustituir_nombres <- function(df, columna, nombres_a_sustituir) {
  diccionario <- c(
    "Cl" = "Arcilloso",
    "SiCl" = "Arcillo limoso",
    "SaCl" = "Sandy clay",
    "ClLo" = "Franco arcilloso",
    "SiClLo" = "Franco arcillo limoso",
    "SaClLo" = "Franco arcillo arenoso",
    "Lo" = "Franco",
    "SiLo" = "Franco limoso",
    "SaLo" = "Franco arenoso",
    "Si" = "Limoso",
    "LoSa" = "Arenoso franco",
    "Sa" = "Arenoso"
  )
  
  # Dividir cada valor de la columna en palabras individuales
  palabras <- strsplit(df[[columna]], " ")
  
  # Aplicar reemplazos en cada palabra
  for (i in seq_along(palabras)) {
    palabras[[i]] <- sapply(palabras[[i]], function(word) {
      if (word %in% names(diccionario)) {
        return(diccionario[[word]])
      } else {
        return(word)
      }
    })
  }
  
  # Unir las palabras de nuevo en frases
  frases <- sapply(palabras, paste, collapse = " ")
  df[[columna]] <- frases
  return(df)
  
}



# filtrado de datos erroneos
horizons_cleaned <- horizons[ which(as.logical(horizons$valid==T)),]
horizons_cleaned$id <- as.numeric(horizons_cleaned$id)
Horizontes_texturas <- as.data.frame(horizons_cleaned)  %>% filter(complete.cases(SILT))
Horizontes_texturas$Clase_textural<- TT.points.in.classes( 
    tri.data    = Horizontes_texturas, 
    class.sys   = "USDA.TT", 
    PiC.type    = "t" 
) 
Texturas<- merge(as.data.frame(horizons_cleaned),Horizontes_texturas %>% select(hzID,Clase_textural),
                 by.x="hzID",by.y="hzID",all.x = T) %>% mutate(hzID=as.numeric(hzID)) %>% arrange(hzID)

Texturas %>% pull(hzID)
#horizons_cleaned$Clase_textural <- c(Texturas$Clase_textural)
horizons_cleaned$Clase_textural <- sustituir_nombres(Texturas, "Clase_textural")%>% pull(Clase_textural)
horizons_cleaned %>% as.data.frame() %>% View()
```

# 2 Graficos de perfiles

```{r include=T, echo=F, message=F, warning=FALSE}
# graphical check
par(mar = c(1,1,1,1))

for(i in 1:length(horizons_cleaned)){
  
  # inspect unique results
  plotSPC(unique(horizons_cleaned[i,], vars = c('top', 'bottom')), 
                name.style = 'center-center', width = 0.15,color="horizons_munsell_color", 
                fixLabelCollisions = TRUE,plot.depth.axis = T,axis.line.offset = -10,
                hz.depths = TRUE,hz.depths.lines=F,hz.depths.offset = c(0.01),shrink=T)
  # plotSPC(horizons_cleaned[i,], cex.names = 1, name.style = 'center-center', width = 0.3, plot.depth.axis = T, hz.depths = TRUE,
  #         hz.depths.lines=T, fixLabelCollisions = TRUE,   hz.depths.offset = c(0.005),
  #         color="horizons_munsell_color")
  }
```
```{r include=F}


texture_df<- as.data.frame(horizons_cleaned) %>% 
  filter(complete.cases(SAND)) %>% 
  mutate(prof_media_horizonte =((top+bottom)/2))

```

```{r include=F , warning=F, message=F}
par(mar=c(0,0,0,0))
plot(horizons_cleaned,main='Valid Horizonation Check')
```
# 3 Análisis Textural

## 3.1 Clasificación textural

A continuación se presenta los resultados de la clasificación textural de los suelos de estudio utilizando el sistema de clasificación de USDA.


```{r echo=F}
library(kableExtra)
kable(horizons_cleaned %>% as.data.frame() %>% 
        select(Mallin,top,bottom,SAND,SILT,CLAY,texture_class,Clase_textural),
      caption = "Clasificación textural de las capas analizadas",digits=1, align = "c")
# %>%
#   kable_styling(bootstrap_options = "centered")
```
## 3.2 Triángulos de textura (USDA)

```{r echo=F , warning=F, message=F}
library(ggtern)
soil_data <- data.frame(
  soil= c("a", "b", "c", "d"),
  sand = c(15, 18, 57, 32),
  silt = c(52, 70, 8, 26),
  clay = c(33, 12, 35, 42),
  om = c(1, 3, 4, 11),
  bd = c(1.33, 1.38, 1.76, 1.15)
)
data(USDA)

USDA <- USDA%>%
  mutate(
    Etiqueta = case_when(
    Label == "Clay" ~ "Arcilloso",
    Label == "Sandy Clay" ~ "Arcillo arenoso",
    Label == "Sandy Clay Loam" ~ "Franco arcillo arenoso",
    Label == "Sandy Loam" ~ "Franco arenoso",
    Label == "Loamy Sand" ~ "Areno franco",
    Label == "Sand" ~ "Arenoso",
    Label == "Clay Loam" ~ "Franco arcilloso",
    Label == "Loam" ~ "Franco",
    Label == "Silt Loam" ~ "Franco limoso",
    Label == "Silty Clay" ~ "Arcillo limoso",
    Label == "Silty Clay Loam" ~ "Franco arcillo limoso",
    Label == "Silt" ~ "Limoso",
    TRUE ~ Label  # Keep other values unchanged
  ),
    Etiqueta_inside = case_when(
    Label == "Clay" ~ "Arcilloso",
    Label == "Sandy Clay" ~ "Arcillo\narenoso",
    Label == "Sandy Clay Loam" ~ "Franco\narcillo\narenoso",
    Label == "Sandy Loam" ~ "Franco\narenoso",
    Label == "Loamy Sand" ~ "Areno\nfranco",
    Label == "Sand" ~ "Arenoso",
    Label == "Clay Loam" ~ "Franco\narcilloso",
    Label == "Loam" ~ "Franco",
    Label == "Silt Loam" ~ "Franco\nlimoso",
    Label == "Silty Clay" ~ "Arcillo\nlimoso",
    Label == "Silty Clay Loam" ~ "Franco\narcillo\nlimoso",
    Label == "Silt" ~ "Limoso",
    TRUE ~ Label  # Keep other values unchanged
  ),
    Ref = case_when(
    Label == "Clay" ~ "A",
    Label == "Sandy Clay" ~ "A-Ar",
    Label == "Sandy Clay Loam" ~ "F-A-Ar",
    Label == "Sandy Loam" ~ "F-A",
    Label == "Loamy Sand" ~ "Ar-F",
    Label == "Sand" ~ "Ar",
    Label == "Clay Loam" ~ "F-A",
    Label == "Loam" ~ "F",
    Label == "Silt Loam" ~ "F-L",
    Label == "Silty Clay" ~ "A-L",
    Label == "Silty Clay Loam" ~ "F-A-L",
    Label == "Silt" ~ "L",
    TRUE ~ Label  # Keep other values unchanged
  ),
  Ref_etiqueta = paste0(Ref,": ",Etiqueta))
USDA$Arena <- USDA$Sand
USDA$Arcilla <- USDA$Clay
USDA$Limo <- USDA$Silt
  
USDA_text <- USDA  %>% group_by(Etiqueta) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

USDA_text <- USDA %>% group_by(Etiqueta)%>%
  mutate(across(where(is.numeric), ~mean(., na.rm = TRUE)))
```

```{r echo=F, warning=F, message=F}
ggplot(data = USDA, aes(
  y = Arcilla,
  x = Arena,
  z = Limo
)) +
  coord_tern(L = "x", T = "y", R = "z") +
  geom_polygon(
    aes(fill = Ref_etiqueta),
    alpha = 0.2,
    size = 0.5,
    color = "black"
  ) +
  geom_text(data = USDA_text,
            aes(label = Ref),
            color = 'black',
            size = 2) +
  geom_point(
    data = texture_df,
    aes(
      x = SAND,
      y = CLAY,
      z = SILT
    ),
  size=0.3) +
  theme_showarrows() +
  theme_clockwise() +
  theme(text = element_text(family = "Helvetica"))  +
   labs(fill = "Referencias") 
  # guides(fill=FALSE, color=FALSE)+

```

```{r echo=F , warning=F, message=F}
theme_set(theme_bw())
ggplot(data = USDA, aes(
  y = Arcilla,
  x = Arena,
  z = Limo
)) +
  coord_tern(L = "x", T = "y", R = "z") +
  geom_polygon(
    aes(fill = Ref_etiqueta),
    alpha = 0.0,
    size = 0.5,
    color = "white"
  ) +
  geom_polygon(
    aes(fill = Ref_etiqueta),
    alpha = 0.0,
    size = 0.5,
    color = "black",
    show.legend =F
  ) +  

  geom_text(data = USDA_text,
            aes(label = Ref),
            color = 'gray58',
            size = 2,show.legend = F) +
  geom_point(
    data = texture_df,
    aes(
      x = SAND,
      y = CLAY,
      z = SILT,
      size =SILT
    ),
  size=0.5) +
  theme_showarrows() +
  theme_clockwise() +
  labs(yarrow = "Arcilla (%)",
       zarrow = "Limo (%)",
       xarrow = "Arena (%)")+
  theme(text = element_text(family = "Helvetica")) +
   labs(fill = "Referencias") 
  #guides(fill=T, color=FALSE)

```

```{r echo=F , warning=F, message=F}
theme_set(theme_bw())
ggplot(data = USDA, aes(
  y = Arcilla,
  x = Arena,
  z = Limo
)) +
  coord_tern(L = "x", T = "y", R = "z") +
  geom_polygon(
    aes(fill =  Etiqueta_inside),
    alpha = 0.0,
    size = 0.5,
    color = "black",
    show.legend =F
  ) +  

  geom_text(data = USDA_text,
            aes(label =  Etiqueta_inside),
            color = 'gray58',
            size = 2,show.legend = F) +
  geom_point(
    data = texture_df,
    aes(
      x = SAND,
      y = CLAY,
      z = SILT,
      size =SILT
    ),
  size=0.5) +
  theme_showarrows() +
  theme_clockwise() +
  labs(yarrow = "Arcilla (%)",
       zarrow = "Limo (%)",
       xarrow = "Arena (%)")+
  theme(text = element_text(family = "Helvetica")) +
   labs(fill = "Referencias") 
  #guides(fill=T, color=FALSE)

```

